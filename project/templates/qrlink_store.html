{% extends "customer_base.html" %}

{% block title %}{{ restaurant.name }} - Menu{% endblock %}

{% block styles %}
<style>
    body { background-color: #f8f9fa; }
    .menu-category-title {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 10;
        padding-top: 1rem;
        padding-bottom: 1rem;
    }
    .cart-fab {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1050;
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div id="category-filter-bar" class="d-flex gap-2 overflow-auto py-2 mb-3" style="position: sticky; top: 0; background: #f8f9fa; z-index: 11;">
    <button class="btn btn-primary active" data-category-filter="all">All</button>
    {% for category in categories %}
        {% if category.items|selectattr('is_available')|list|length > 0 %}
        <button class="btn btn-outline-secondary" data-category-filter="{{ category.id }}">{{ category.name }}</button>
        {% endif %}
    {% endfor %}
</div>

<div id="menu-items-container">
    {% for category in categories %}
        {% if category.items|selectattr('is_available')|list|length > 0 %}
        <div class="category-section" id="category-section-{{ category.id }}" data-category-id="{{ category.id }}">
            <h3 class="menu-category-title fw-bold">{{ category.name }}</h3>
            <div class="row g-3">
                {% for item in category.items if item.is_available %}
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-body d-flex">
                            <div class="flex-grow-1">
                                <h5 class="card-title fw-bold">{{ item.name }}</h5>
                                <p class="card-text small text-muted">{{ item.description }}</p>
                                <p class="card-text fw-bold">${{ "%.2f"|format(item.price) }}</p>
                            </div>
                            <div class="ms-3">
                                <button class="btn btn-primary" onclick="addToCart('{{ item.id }}', '{{ item.name }}', {{ item.price }})">
                                    Add
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    {% endfor %}
</div>

<!-- Floating Cart Button -->
<a href="{{ url_for('qrlink.customer_checkout', slug=restaurant.slug, table=table.number if table else None, type=request.args.get('type')) }}" id="cart-button" class="btn btn-primary rounded-circle shadow-lg cart-fab d-none">
    <i class="bi bi-cart"></i>
    <span id="cart-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
</a>
{% endblock %}

{% block scripts %}
<script>
    // --- Cart Logic ---
    function getCart() {
        return JSON.parse(localStorage.getItem('cart') || '{}');
    }

    function saveCart(cart) {
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartUI();
    }

    function addToCart(id, name, price) {
        const cart = getCart();
        if (cart[id]) {
            cart[id].quantity++;
        } else {
            cart[id] = { id, name, price, quantity: 1 };
        }
        saveCart(cart);
    }

    function updateCartUI() {
        const cart = getCart();
        const countEl = document.getElementById('cart-count');
        const cartButton = document.getElementById('cart-button');
        let itemCount = 0;
        for (const id in cart) {
            itemCount += cart[id].quantity;
        }
        countEl.textContent = itemCount;
        cartButton.classList.toggle('d-none', itemCount === 0);
    }

    // --- Filter Logic ---
    document.addEventListener('DOMContentLoaded', function() {
        updateCartUI(); // Initial UI update on page load

        const filterButtons = document.querySelectorAll('#category-filter-bar button');
        const categorySections = document.querySelectorAll('.category-section');

        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                filterButtons.forEach(btn => {
                    btn.classList.remove('btn-primary', 'active');
                    btn.classList.add('btn-outline-secondary');
                });
                this.classList.add('btn-primary', 'active');
                this.classList.remove('btn-outline-secondary');

                const filter = this.getAttribute('data-category-filter');

                categorySections.forEach(section => {
                    section.style.display = (filter === 'all' || section.getAttribute('data-category-id') === filter) ? 'block' : 'none';
                });
            });
        });
    });
</script>
{% endblock %}