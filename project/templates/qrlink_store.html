{% extends "customer_base.html" %}

{% block title %}{{ restaurant.name }} - Menu{% endblock %}

{% block styles %}
<style>
    body { background-color: #f8f9fa; }
    .menu-category-title {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 10;
    }
    .cart-fab {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1050;
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div id="category-filter-bar" class="d-flex gap-2 overflow-auto py-2 mb-3" style="position: sticky; top: 0; background: #f8f9fa; z-index: 11;">
    <button class="btn btn-primary active" data-category-filter="all">All</button>
    {% for category in categories %}
        {% if category.items|selectattr('is_available')|list|length > 0 %}
        <button class="btn btn-outline-secondary" data-category-filter="{{ category.id }}">{{ category.name }}</button>
        {% endif %}
    {% endfor %}
</div>

<div id="menu-items-container">
    {% for category in categories %}
        {% if category.items|selectattr('is_available')|list|length > 0 %}
        <div class="category-section mb-5" id="category-section-{{ category.id }}" data-category-id="{{ category.id }}">
            <h2 class="menu-category-title fw-bold py-3">{{ category.name }}</h2>
            <div class="row g-4">
                {% for item in category.items if item.is_available %}
                <div class="col-12">
                    <div class="card border-0 shadow-sm h-100" style="cursor: pointer;" onclick="addToCart('{{ item.id }}', '{{ item.name }}', {{ item.price }})">
                        <div class="row g-0">
                            <div class="col-8">
                                <div class="card-body d-flex flex-column h-100">
                                    <h5 class="card-title fw-bold">{{ item.name }}</h5>
                                    <p class="card-text small text-muted flex-grow-1">{{ item.description }}</p>
                                    <p class="card-text fs-5 fw-bold text-primary mb-0">${{ "%.2f"|format(item.price) }}</p>
                                </div>
                            </div>
                            <div class="col-4">
                                <img src="{{ url_for('admin.serve_menu_image', item_id=item.id) }}" class="img-fluid rounded-end h-100" style="object-fit: cover;" alt="{{ item.name }}">
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    {% endfor %}
</div>

<!-- Floating Cart Button -->
<a href="{{ url_for('qrlink.customer_checkout', slug=restaurant.slug, table=table.number if table else None, type=request.args.get('type')) }}" id="cart-button" class="btn btn-primary rounded-circle shadow-lg cart-fab d-none d-flex align-items-center justify-content-center">
    <i class="bi bi-cart"></i>
    <span id="cart-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
</a>
{% endblock %}

{% block scripts %}
<script>
    // --- Cart Logic ---
    function getCart() {
        return JSON.parse(localStorage.getItem('cart') || '{}');
    }

    function saveCart(cart) {
        localStorage.setItem('cart', JSON.stringify(cart));
        updateCartUI();
    }

    function addToCart(id, name, price) {
        const cart = getCart();
        if (cart[id]) {
            cart[id].quantity++;
        } else {
            cart[id] = { id, name, price, quantity: 1 };
        }
        saveCart(cart);
    }

    function updateCartUI() {
        const cart = getCart();
        const countEl = document.getElementById('cart-count');
        const cartButton = document.getElementById('cart-button');
        let itemCount = 0;
        for (const id in cart) {
            itemCount += cart[id].quantity;
        }
        countEl.textContent = itemCount;
        cartButton.classList.toggle('d-none', itemCount === 0);
    }

    // --- Filter Logic ---
    document.addEventListener('DOMContentLoaded', function() {
        updateCartUI(); // Initial UI update on page load

        const filterButtons = document.querySelectorAll('#category-filter-bar button');
        const categorySections = document.querySelectorAll('.category-section');

        filterButtons.forEach(button => {
            button.addEventListener('click', function() {
                filterButtons.forEach(btn => {
                    btn.classList.remove('btn-primary', 'active');
                    btn.classList.add('btn-outline-secondary');
                });
                this.classList.add('btn-primary', 'active');
                this.classList.remove('btn-outline-secondary');

                const filter = this.getAttribute('data-category-filter');

                categorySections.forEach(section => {
                    section.style.display = (filter === 'all' || section.getAttribute('data-category-id') === filter) ? 'block' : 'none';
                });
            });
        });
    });
</script>
{% endblock %}