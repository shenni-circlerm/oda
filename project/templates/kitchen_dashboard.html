{% extends "base.html" %}

{% block title %}Kitchen Dashboard{% endblock %}

{% block styles %}
<style>
    .station-columns {
        display: flex;
        gap: 1rem;
        overflow-x: auto;
        padding-bottom: 1rem;
        min-height: calc(100vh - 200px);
    }
    .station-col {
        min-width: 320px;
        max-width: 320px;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        height: fit-content;
    }
    .station-header {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #dee2e6;
    }
    .station-body {
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    .item-ticket {
        transition: opacity 0.3s ease-out;
    }
    .drag-over {
        background-color: #e9ecef;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold mb-0">Kitchen Orders by Station</h2>
    <span class="badge bg-success">Live</span>
</div>

<div class="d-flex gap-2 mb-3 border-bottom pb-3">
    <button class="btn btn-primary rounded-pill" onclick="filterStations('all')">All Stations</button>
    {% for station in stations %}
    <button class="btn btn-outline-secondary rounded-pill" onclick="filterStations('{{ station.id }}')">{{ station.name }}</button>
    {% endfor %}
    {% if uncategorized_items %}
    <button class="btn btn-outline-secondary rounded-pill" onclick="filterStations('uncategorized')">Unassigned</button>
    {% endif %}
</div>

<div class="station-columns" id="station-columns">
    <!-- Loop through stations -->
    {% for station in stations %}
    <div class="station-col shadow-sm" data-station-id="{{ station.id }}">
        <div class="station-header">
            <h5 class="fw-bold mb-0">{{ station.name }}</h5>
        </div>
        <div class="station-body drop-zone" id="station-body-{{ station.id }}" data-station-id="{{ station.id }}">
            {% for item in station_items.get(station.id, []) %}
            <div class="card item-ticket" id="item-ticket-{{ item.id }}" draggable="true" data-item-id="{{ item.menu_item.id }}">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="fw-bold mb-0">{{ item.quantity }}x {{ item.menu_item.name }}</h5>
                        <span class="badge bg-light text-dark border">Table {{ item.order.table.number }}</span>
                    </div>
                    <p class="text-muted small mb-2">Order #{{ item.order.id }} &bull; {{ item.created_at.strftime('%H:%M:%S') }}</p>
                    <div class="d-grid">
                        <button class="btn btn-sm btn-outline-success" onclick="markItemReady({{ item.id }})">Mark Ready</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}

    <!-- Uncategorized Station -->
    {% if uncategorized_items %}
    <div class="station-col shadow-sm" data-station-id="uncategorized">
        <div class="station-header">
            <h5 class="fw-bold mb-0 text-secondary">Unassigned</h5>
        </div>
        <div class="station-body drop-zone" id="station-body-uncategorized" data-station-id="uncategorized">
            {% for item in uncategorized_items %}
            <div class="card item-ticket" id="item-ticket-{{ item.id }}" draggable="true" data-item-id="{{ item.menu_item.id }}">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h5 class="fw-bold mb-0">{{ item.quantity }}x {{ item.menu_item.name }}</h5>
                        <span class="badge bg-light text-dark border">Table {{ item.order.table.number }}</span>
                    </div>
                    <p class="text-muted small mb-2">Order #{{ item.order.id }} &bull; {{ item.created_at.strftime('%H:%M:%S') }}</p>
                    <div class="d-grid">
                        <button class="btn btn-sm btn-outline-success" onclick="markItemReady({{ item.id }})">Mark Ready</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function markItemReady(itemId) {
    fetch(`/admin/order-item/status/${itemId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'ready' })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const ticket = document.getElementById(`item-ticket-${itemId}`);
            if (ticket) {
                ticket.style.opacity = '0';
                setTimeout(() => ticket.remove(), 300);
            }
        } else {
            alert('Failed to update item status.');
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('An error occurred.');
    });
}

function filterStations(stationId) {
    const columnsContainer = document.getElementById('station-columns');
    const columns = columnsContainer.querySelectorAll('.station-col');
    
    columns.forEach(col => {
        if (stationId === 'all' || col.dataset.stationId === stationId) {
            col.style.display = 'block';
        } else {
            col.style.display = 'none';
        }
    });
}

document.addEventListener('DOMContentLoaded', function () {
    let draggedItem = null;

    document.querySelectorAll('.item-ticket').forEach(ticket => {
        ticket.addEventListener('dragstart', function(e) {
            draggedItem = e.target;
            setTimeout(() => {
                e.target.style.opacity = '0.5';
            }, 0);
        });

        ticket.addEventListener('dragend', function(e) {
            draggedItem = null;
            e.target.style.opacity = '1';
            document.querySelectorAll('.drag-over').forEach(dz => dz.classList.remove('drag-over'));
        });
    });

    document.querySelectorAll('.drop-zone').forEach(zone => {
        zone.addEventListener('dragover', function(e) {
            e.preventDefault();
        });

        zone.addEventListener('dragenter', function(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        });

        zone.addEventListener('dragleave', function(e) {
            this.classList.remove('drag-over');
        });

        zone.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('drag-over');
            if (draggedItem) {
                const menuItemId = draggedItem.dataset.itemId;
                const newStationId = this.dataset.stationId;

                // Move the element in the UI
                this.appendChild(draggedItem);

                // Send the update to the backend
                fetch(`/admin/item/${menuItemId}/assign-station`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ station_id: newStationId })
                })
                .then(response => response.json())
                .then(data => console.log(data.message || 'Error'))
                .catch(err => console.error('Error:', err));
            }
        });
    });
});
</script>
{% endblock %}