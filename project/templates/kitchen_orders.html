{% extends "base.html" %}

{% block title %}Kitchen Orders{% endblock %}

{% block styles %}
<style>
    .kitchen-header {
        background: white;
        padding: 1.25rem 2.5rem;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    .station-columns {
        display: flex;
        gap: 1.25rem;
        overflow-x: auto;
        padding: 1.5rem 2.5rem;
        flex-grow: 1;
    }
    .station-col {
        min-width: 340px;
        max-width: 340px;
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    .station-card {
        background: #e2e8f0;
        border-radius: var(--radius-lg);
        display: flex;
        flex-direction: column;
        max-height: 100%;
        border: 1px solid rgba(0,0,0,0.05);
    }
    .station-header {
        padding: 1rem 1.25rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .station-body {
        padding: 0.75rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        min-height: 200px;
    }
    .item-ticket {
        background: white;
        border-radius: var(--radius-sm);
        padding: 1rem;
        border: 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        border-left: 4px solid #cbd5e1;
        transition: transform 0.1s;
    }
    .item-ticket:active { transform: scale(0.98); }
    
    .status-pending { border-left-color: #fbbf24; }
    .status-preparing { border-left-color: var(--primary-color); background: #fef2f2; }
    
    .timer { font-variant-numeric: tabular-nums; font-weight: 600; font-size: 0.8rem; }

    .empty-state-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        width: 100%;
        text-align: center;
        padding: 3rem;
    }
    .empty-station-placeholder {
        opacity: 0.5;
        border: 2px dashed #cbd5e1;
        border-radius: var(--radius-sm);
        padding: 2rem;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="design-container" style="display: flex; flex-direction: column; background-color: #f1f5f9;">
    <div class="kitchen-header d-flex justify-content-between align-items-center">
        <div>
            <h2 class="fw-bold mb-0">Live Kitchen</h2>
            {% if stations %}
            <p class="text-muted small mb-0">Managing {{ active_items|length }} active items</p>
            {% endif %}
        </div>
        
        {% if stations %}
        <div id="station-filter-group" class="btn-group shadow-sm bg-white p-1 rounded-pill">
            <input type="checkbox" class="btn-check" id="filter-all" checked>
            <label class="btn btn-sm btn-outline-primary border-0 rounded-pill px-3" for="filter-all">All Stations</label>
            {% for station in stations %}
            <input type="checkbox" class="btn-check" id="st-{{ station.id }}" data-station-id="{{ station.id }}">
            <label class="btn btn-sm btn-outline-primary border-0 rounded-pill px-3" for="st-{{ station.id }}">{{ station.name }}</label>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    {% if not stations %}
    <div class="empty-state-container">
        <div class="bg-white p-5 shadow-sm rounded-4" style="max-width: 500px;">
            <div class="mb-4">
                <i class="bi bi-display fs-1 text-primary opacity-50"></i>
            </div>
            <h3 class="fw-bold">No Kitchen Stations Found</h3>
            <p class="text-muted mb-4">You need to create at least one kitchen station to see and manage incoming orders.</p>
            <a href="{{ url_for('admin.kitchen_manage_stations') }}" class="btn btn-primary px-4 py-2 rounded-pill fw-bold">
                Configure Stations
            </a>
        </div>
    </div>
    {% else %}
    <div class="station-columns" id="station-columns">
        {% for station in stations %}
        <div class="station-col" data-station-id="{{ station.id }}">
            <div class="station-card shadow-sm">
                <div class="station-header">
                    <h6 class="fw-bold mb-0 text-uppercase tracking-wider small">{{ station.name }}</h6>
                    <span class="badge bg-white text-dark rounded-pill shadow-sm small">
                        {{ station_items[station.id]|length }}
                    </span>
                </div>
                <div class="station-body">
                    {% for item in station_items[station.id] %}
                    <div class="item-ticket status-{{ item.status }}">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="badge bg-dark rounded-pill">Table {{ item.order.table.number }}</span>
                            <span class="timer text-danger" data-timestamp="{{ item.created_at.isoformat() }}Z"><i class="bi bi-clock-history me-1"></i>00:00</span>
                        </div>
                        <h5 class="fw-bold mb-1">{{ item.quantity }}x {{ item.menu_item.name }}</h5>
                        <button class="btn btn-sm btn-primary w-100 rounded-pill">Done</button>
                    </div>
                    {% else %}
                        <div class="empty-station-placeholder">
                            <i class="bi bi-check2-circle mb-2 d-block fs-4 text-muted"></i>
                            <span class="smallest fw-bold text-muted text-uppercase">Clear</span>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}

        {% if uncategorized_items %}
        <div class="station-col" data-station-id="uncategorized">
            <div class="station-card shadow-sm">
                <div class="station-header">
                    <h6 class="fw-bold mb-0 text-uppercase tracking-wider small">Uncategorized</h6>
                    <span class="badge bg-white text-dark rounded-pill shadow-sm small">
                        {{ uncategorized_items|length }}
                    </span>
                </div>
                <div class="station-body">
                    {% for item in uncategorized_items %}
                    <div class="item-ticket status-{{ item.status }}">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="badge bg-dark rounded-pill">Table {{ item.order.table.number }}</span>
                            <span class="timer text-danger" data-timestamp="{{ item.created_at.isoformat() }}Z"><i class="bi bi-clock-history me-1"></i>00:00</span>
                        </div>
                        <h5 class="fw-bold mb-1">{{ item.quantity }}x {{ item.menu_item.name }}</h5>
                        <button class="btn btn-sm btn-primary w-100 rounded-pill">Done</button>
                    </div>
                    {% else %}
                        <div class="empty-station-placeholder">
                            <i class="bi bi-check2-circle mb-2 d-block fs-4 text-muted"></i>
                            <span class="smallest fw-bold text-muted text-uppercase">Clear</span>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function updateElapsedTimes() {
    document.querySelectorAll('.timer').forEach(el => {
        const timestamp = el.dataset.timestamp;
        if (timestamp) {
            const startTime = new Date(timestamp);
            const now = new Date();
            const diff = Math.floor((now - startTime) / 1000);

            if (diff < 0) return;

            const minutes = Math.floor(diff / 60);
            const seconds = diff % 60;

            el.innerHTML = `<i class="bi bi-clock-history me-1"></i>${minutes}m ${seconds.toString().padStart(2, '0')}s`;
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    updateElapsedTimes();
    setInterval(updateElapsedTimes, 1000);
});
</script>
{% endblock %}