{% extends "base.html" %}

{% block title %}Kitchen Orders{% endblock %}

{% block styles %}
<style>
    .kitchen-header {
        background: white;
        padding: 1.25rem 2.5rem;
        border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    .station-columns {
        display: flex;
        gap: 1.25rem;
        overflow-x: auto;
        padding: 1.5rem 2.5rem;
        flex-grow: 1;
    }
    .station-col {
        min-width: 340px;
        max-width: 340px;
        display: flex;
        flex-direction: column;
        height: 100%;
    }
    .station-card {
        background: #e2e8f0;
        border-radius: var(--radius-lg);
        display: flex;
        flex-direction: column;
        max-height: 100%;
        border: 1px solid rgba(0,0,0,0.05);
    }
    .station-header {
        padding: 1rem 1.25rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .station-body {
        padding: 0.75rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        min-height: 200px;
    }
    .item-ticket {
        background: white;
        border-radius: var(--radius-sm);
        padding: 1rem;
        border: 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        border-left: 4px solid #cbd5e1;
        transition: transform 0.1s;
    }
    .item-ticket:active { transform: scale(0.98); }
    
    .status-pending { border-left-color: #fbbf24; }
    .status-preparing { border-left-color: #0d6efd; background: #eff6ff; }
    .status-ready { border-left-color: #198754; background: #f0fdf4; opacity: 0.8; }
    
    .item-ticket.was-printed {
        opacity: 0.6;
    }
    .item-ticket.was-printed::after {
        content: "\F4FF"; /* Bootstrap Icon for printer */
        font-family: "bootstrap-icons";
        position: absolute;
        top: 10px;
        right: 10px;
        color: #6c757d;
    }
    .timer { font-variant-numeric: tabular-nums; font-weight: 600; font-size: 0.8rem; }

    .empty-state-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        width: 100%;
        text-align: center;
        padding: 3rem;
    }
    .empty-station-placeholder {
        opacity: 0.5;
        border: 2px dashed #cbd5e1;
        border-radius: var(--radius-sm);
        padding: 2rem;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="design-container" style="display: flex; flex-direction: column; background-color: #f1f5f9;">
    <div class="kitchen-header d-flex justify-content-between align-items-center">
        <div>
            <h2 class="fw-bold mb-0">Live Kitchen</h2>
            {% if stations %}
            <p class="text-muted small mb-0">Managing {{ active_items|length }} active items</p>
            {% endif %}
        </div>
        
        {% if stations %}
        <div id="station-filter-group" class="btn-group shadow-sm bg-white p-1 rounded-pill">
            <input type="checkbox" class="btn-check" id="filter-all" checked>
            <label class="btn btn-sm btn-outline-primary border-0 rounded-pill px-3" for="filter-all">All Stations</label>
            {% for station in stations %}
            <input type="checkbox" class="btn-check" id="st-{{ station.id }}" data-station-id="{{ station.id }}">
            <label class="btn btn-sm btn-outline-primary border-0 rounded-pill px-3" for="st-{{ station.id }}">{{ station.name }}</label>
            {% endfor %}
            {% if uncategorized_items %}
            <input type="checkbox" class="btn-check" id="st-uncategorized" data-station-id="uncategorized">
            <label class="btn btn-sm btn-outline-primary border-0 rounded-pill px-3" for="st-uncategorized">No Station</label>
            {% endif %}
        </div>
        {% endif %}
    </div>

    {% if not stations %}
    <div class="empty-state-container">
        <div class="bg-white p-5 shadow-sm rounded-4" style="max-width: 500px;">
            <div class="mb-4">
                <i class="bi bi-display fs-1 text-primary opacity-50"></i>
            </div>
            <h3 class="fw-bold">No Kitchen Stations Found</h3>
            <p class="text-muted mb-4">You need to create at least one kitchen station to see and manage incoming orders.</p>
            <a href="{{ url_for('admin.kitchen_manage_stations') }}" class="btn btn-primary px-4 py-2 rounded-pill fw-bold">
                Configure Stations
            </a>
        </div>
    </div>
    {% else %}
    <div class="station-columns" id="station-columns">
        {% for station in stations %}
        <div class="station-col" data-station-id="{{ station.id }}">
            <div class="station-card shadow-sm">
                <div class="station-header">
                    <h6 class="fw-bold mb-0 text-uppercase tracking-wider small">{{ station.name }}</h6>
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-sm btn-light border rounded-pill px-3" onclick="printStationTickets('{{ station.id }}')"><i class="bi bi-printer-fill me-1"></i> Print New</button>
                        <span class="badge bg-white text-dark rounded-pill shadow-sm small">{{ station_items[station.id]|length }}</span>
                    </div>
                </div>
                <div class="station-body">
                    {% for item in station_items[station.id] %}
                    <div class="item-ticket status-{{ item.status }}" draggable="true" 
                         data-menu-item-id="{{ item.menu_item.id }}"
                         data-item-name="{{ item.menu_item.name|replace("'", "\\'") }}"
                         data-item-qty="{{ item.quantity }}"
                         data-table-num="{{ item.order.table.number }}"
                         data-item-notes="{{ (item.notes or '')|replace("'", "\\'") }}">
                        <div class="d-flex justify-content-between mb-2">
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-dark rounded-pill">Table {{ item.order.table.number }}</span>
                                {% if item.status == 'preparing' %}<span class="badge bg-primary rounded-pill">Cooking</span>{% endif %}
                                {% if item.status == 'ready' %}<span class="badge bg-success rounded-pill">Ready</span>{% endif %}
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <button class="btn btn-link btn-sm p-0 text-muted" onclick="printTicket('{{ item.menu_item.name|replace("'", "\\'") }}', '{{ item.quantity }}', '{{ item.order.table.number }}', '{{ (item.notes or '')|replace("'", "\\'") }}')">
                                    <i class="bi bi-printer"></i>
                                </button>
                                <span class="timer text-danger" data-timestamp="{{ item.created_at.isoformat() }}Z"><i class="bi bi-clock-history me-1"></i>00:00</span>
                            </div>
                        </div>
                        <h5 class="fw-bold mb-1">{{ item.quantity }}x {{ item.menu_item.name }}</h5>
                        {% if item.notes %}
                        <div class="p-2 mt-2 bg-warning-subtle text-warning-emphasis border border-warning-subtle rounded-3 small fst-italic"><i class="bi bi-chat-left-text-fill me-2"></i>{{ item.notes }}</div>
                        {% endif %}
                        {% if item.selected_modifiers %}
                        <div class="ps-3 mt-2">
                            {% for mod in item.selected_modifiers %}<div class="small text-muted fw-bold">+ {{ mod.name }}</div>{% endfor %}
                        </div>
                        {% endif %}
                        <div class="d-flex gap-2 mt-2">
                            {% if item.status == 'ready' %}
                            <button class="btn btn-sm btn-outline-success flex-grow-1 rounded-pill" onclick="updateItemStatus('{{ item.id }}', 'served', this)">
                                <i class="bi bi-check-all"></i> Clear
                            </button>
                            {% else %}
                            {% if item.status == 'pending' %}
                            <button class="btn btn-sm btn-outline-primary flex-grow-1 rounded-pill" onclick="updateItemStatus('{{ item.id }}', 'preparing', this)">
                                <i class="bi bi-fire"></i> Cook
                            </button>
                            {% endif %}
                            <button class="btn btn-sm btn-primary flex-grow-1 rounded-pill" onclick="updateItemStatus('{{ item.id }}', 'complete', this)">
                                <i class="bi bi-check2"></i> Done
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                        <div class="empty-station-placeholder">
                            <i class="bi bi-check2-circle mb-2 d-block fs-4 text-muted"></i>
                            <span class="smallest fw-bold text-muted text-uppercase">Clear</span>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}

        {% if uncategorized_items %}
        <div class="station-col" data-station-id="uncategorized">
            <div class="station-card shadow-sm">
                <div class="station-header">
                    <h6 class="fw-bold mb-0 text-uppercase tracking-wider small">Uncategorized</h6>
                    <div class="d-flex align-items-center gap-2">
                        <button class="btn btn-sm btn-light border rounded-pill px-3" onclick="printStationTickets('uncategorized')"><i class="bi bi-printer-fill me-1"></i> Print New</button>
                        <span class="badge bg-white text-dark rounded-pill shadow-sm small">{{ uncategorized_items|length }}</span>
                    </div>
                </div>
                <div class="station-body">
                    {% for item in uncategorized_items %}
                    <div class="item-ticket status-{{ item.status }}" draggable="true" 
                         data-menu-item-id="{{ item.menu_item.id }}"
                         data-item-name="{{ item.menu_item.name|replace("'", "\\'") }}"
                         data-item-qty="{{ item.quantity }}"
                         data-table-num="{{ item.order.table.number }}"
                         data-item-notes="{{ (item.notes or '')|replace("'", "\\'") }}">
                        <div class="d-flex justify-content-between mb-2">
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-dark rounded-pill">Table {{ item.order.table.number }}</span>
                                {% if item.status == 'preparing' %}<span class="badge bg-primary rounded-pill">Cooking</span>{% endif %}
                                {% if item.status == 'ready' %}<span class="badge bg-success rounded-pill">Ready</span>{% endif %}
                            </div>
                            <div class="d-flex align-items-center gap-2">
                                <button class="btn btn-link btn-sm p-0 text-muted" onclick="printTicket('{{ item.menu_item.name|replace("'", "\\'") }}', '{{ item.quantity }}', '{{ item.order.table.number }}', '{{ (item.notes or '')|replace("'", "\\'") }}')">
                                    <i class="bi bi-printer"></i>
                                </button>
                                <span class="timer text-danger" data-timestamp="{{ item.created_at.isoformat() }}Z"><i class="bi bi-clock-history me-1"></i>00:00</span>
                            </div>
                        </div>
                        <h5 class="fw-bold mb-1">{{ item.quantity }}x {{ item.menu_item.name }}</h5>
                        {% if item.notes %}
                        <div class="p-2 mt-2 bg-warning-subtle text-warning-emphasis border border-warning-subtle rounded-3 small fst-italic"><i class="bi bi-chat-left-text-fill me-2"></i>{{ item.notes }}</div>
                        {% endif %}
                        {% if item.selected_modifiers %}
                        <div class="ps-3 mt-2">
                            {% for mod in item.selected_modifiers %}<div class="small text-muted fw-bold">+ {{ mod.name }}</div>{% endfor %}
                        </div>
                        {% endif %}
                        <div class="d-flex gap-2 mt-2">
                            {% if item.status == 'ready' %}
                            <button class="btn btn-sm btn-outline-success flex-grow-1 rounded-pill" onclick="updateItemStatus('{{ item.id }}', 'served', this)">
                                <i class="bi bi-check-all"></i> Clear
                            </button>
                            {% else %}
                            {% if item.status == 'pending' %}
                            <button class="btn btn-sm btn-outline-primary flex-grow-1 rounded-pill" onclick="updateItemStatus('{{ item.id }}', 'preparing', this)">
                                <i class="bi bi-fire"></i> Cook
                            </button>
                            {% endif %}
                            <button class="btn btn-sm btn-primary flex-grow-1 rounded-pill" onclick="updateItemStatus('{{ item.id }}', 'complete', this)">
                                <i class="bi bi-check2"></i> Done
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                        <div class="empty-station-placeholder">
                            <i class="bi bi-check2-circle mb-2 d-block fs-4 text-muted"></i>
                            <span class="smallest fw-bold text-muted text-uppercase">Clear</span>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function updateElapsedTimes() {
    document.querySelectorAll('.timer').forEach(el => {
        const timestamp = el.dataset.timestamp;
        if (timestamp) {
            const startTime = new Date(timestamp);
            const now = new Date();
            const diff = Math.floor((now - startTime) / 1000);

            if (diff < 0) return;

            const minutes = Math.floor(diff / 60);
            const seconds = diff % 60;

            el.innerHTML = `<i class="bi bi-clock-history me-1"></i>${minutes}m ${seconds.toString().padStart(2, '0')}s`;
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    updateElapsedTimes();
    setInterval(updateElapsedTimes, 1000);
    
    // Initial sort of all stations
    document.querySelectorAll('.station-body').forEach(sortStation);

    // 1. Auto-refresh page every 15 seconds to check for new orders
    setTimeout(function() {
        window.location.reload();
    }, 15000);

    // 2. Station Filtering Logic
    const allCheck = document.getElementById('filter-all');
    const stationChecks = document.querySelectorAll('.btn-check[data-station-id]');
    const columns = document.querySelectorAll('.station-col');

    // Restore filter state from local storage
    const savedFilters = JSON.parse(localStorage.getItem('kitchen_station_filters') || '[]');
    if (savedFilters.length > 0 && !savedFilters.includes('all')) {
        if(allCheck) allCheck.checked = false;
        stationChecks.forEach(cb => {
            cb.checked = savedFilters.includes(cb.dataset.stationId);
        });
    } else {
        if(allCheck) allCheck.checked = true;
        stationChecks.forEach(cb => cb.checked = false);
    }
    // Apply visibility based on restored state
    updateVisibility();

    function updateVisibility() {
        const showAll = allCheck.checked;
        const activeIds = Array.from(stationChecks)
            .filter(cb => cb.checked)
            .map(cb => cb.dataset.stationId);

        columns.forEach(col => {
            const colId = col.dataset.stationId;
            if (showAll || activeIds.includes(colId)) {
                col.style.display = 'flex';
            } else {
                col.style.display = 'none';
            }
        });
    }

    if(allCheck) {
        allCheck.addEventListener('change', function() {
            if(this.checked) {
                stationChecks.forEach(cb => cb.checked = false);
                localStorage.setItem('kitchen_station_filters', JSON.stringify(['all']));
            }
            updateVisibility();
        });

        stationChecks.forEach(cb => {
            cb.addEventListener('change', function() {
                if(this.checked) allCheck.checked = false;
                if(!this.checked && Array.from(stationChecks).every(c => !c.checked)) {
                    allCheck.checked = true;
                    localStorage.setItem('kitchen_station_filters', JSON.stringify(['all']));
                } else {
                    // Save specific station selection
                    const activeIds = Array.from(stationChecks)
                        .filter(c => c.checked)
                        .map(c => c.dataset.stationId);
                    localStorage.setItem('kitchen_station_filters', JSON.stringify(activeIds));
                }
                updateVisibility();
            });
        });
    }

    // 3. Item Status Logic (Preparing / Complete)
    window.updateItemStatus = function(itemId, status, btn) {
        const card = btn.closest('.item-ticket');
        const originalContent = btn.innerHTML;
        
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        // Send request to backend
        fetch('/kitchen/item/' + itemId + '/' + status, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        }).then(res => {
            if (res.ok) {
                if (status === 'served') {
                    // Remove card when cleared
                    card.style.transition = 'all 0.3s ease';
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.9)';
                    setTimeout(() => card.remove(), 300);
                } else if (status === 'complete') {
                    // Move to bottom and mark as ready
                    card.classList.remove('status-preparing', 'status-pending');
                    card.classList.add('status-ready');
                    
                    // Update button to "Clear"
                    btn.parentElement.innerHTML = `
                        <button class="btn btn-sm btn-outline-success flex-grow-1 rounded-pill" onclick="updateItemStatus('${itemId}', 'served', this)">
                            <i class="bi bi-check-all"></i> Clear
                        </button>
                    `;

                    // Add badge
                    const headerGroup = card.querySelector('.d-flex.align-items-center.gap-2');
                    if(headerGroup && !headerGroup.querySelector('.bg-success')) {
                        headerGroup.insertAdjacentHTML('beforeend', '<span class="badge bg-success rounded-pill">Ready</span>');
                    }
                    
                    // Sort station to move this item to bottom
                    sortStation(card.parentElement);
                } else if (status === 'preparing') {
                    card.classList.remove('status-pending');
                    card.classList.add('status-preparing');
                    btn.remove(); // Remove the "Cook" button

                    // Add visual badge to header for immediate feedback
                    const headerGroup = card.querySelector('.d-flex.align-items-center.gap-2');
                    if(headerGroup) {
                        headerGroup.insertAdjacentHTML('beforeend', '<span class="badge bg-primary rounded-pill">Cooking</span>');
                    }
                }
            } else {
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }).catch(err => {
            console.error('Error completing item:', err);
            btn.disabled = false;
            btn.innerHTML = originalContent;
        });
    };

    // 4. Drag and Drop Logic (Kanban)
    const draggables = document.querySelectorAll('.item-ticket');
    const containers = document.querySelectorAll('.station-body');
    let originalDragContainer = null; // Variable to store the source column

    draggables.forEach(draggable => {
        draggable.addEventListener('dragstart', () => {
            draggable.classList.add('dragging');
            draggable.style.opacity = '0.5';
            originalDragContainer = draggable.closest('.station-body');
        });

        draggable.addEventListener('dragend', () => {
            draggable.classList.remove('dragging');
            draggable.style.opacity = '1';
            originalDragContainer = null; // Reset after drag operation
        });
    });

    containers.forEach(container => {
        container.addEventListener('dragover', e => {
            e.preventDefault();
            const afterElement = getDragAfterElement(container, e.clientY);
            const draggable = document.querySelector('.dragging');
            if (draggable) {
                if (afterElement == null) {
                    container.appendChild(draggable);
                } else {
                    container.insertBefore(draggable, afterElement);
                }
            }
        });

        container.addEventListener('drop', e => {
            e.preventDefault();
            const draggable = document.querySelector('.dragging');
            if (!draggable) return;
            
            // After drop, ensure placeholders are correct in both source and destination.
            // The draggable is already in the new container due to the 'dragover' event.
            ensurePlaceholderState(container);
            if (originalDragContainer && originalDragContainer !== container) {
                ensurePlaceholderState(originalDragContainer);
            }

            const stationCol = container.closest('.station-col');
            const newStationId = stationCol.dataset.stationId;
            const menuItemId = draggable.dataset.menuItemId;

            // Send update to backend to reconfigure the menu item's default station
            fetch('/kitchen/update_item_station', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    menu_item_id: menuItemId,
                    station_id: newStationId === 'uncategorized' ? null : newStationId
                })
            }).then(res => {
                if(res.ok) {
                    // Visual feedback is already handled by the drop
                    sortStation(container);
                    // The auto-refresh will eventually sync other items of the same type
                }
            });
        });
    });

    // Helper to manage the "Clear" placeholder in empty stations
    function ensurePlaceholderState(container) {
        if (!container) return;
        const placeholder = container.querySelector('.empty-station-placeholder');
        const hasItems = container.querySelector('.item-ticket');

        if (hasItems && placeholder) {
            placeholder.remove();
        } else if (!hasItems && !placeholder) {
            const newPlaceholder = document.createElement('div');
            newPlaceholder.className = 'empty-station-placeholder';
            newPlaceholder.innerHTML = `
                <i class="bi bi-check2-circle mb-2 d-block fs-4 text-muted"></i>
                <span class="smallest fw-bold text-muted text-uppercase">Clear</span>
            `;
            container.appendChild(newPlaceholder);
        }
    }

    // Helper to keep Ready items at the bottom
    function sortStation(container) {
        const items = [...container.querySelectorAll('.item-ticket')];
        items.sort((a, b) => {
            const aReady = a.classList.contains('status-ready');
            const bReady = b.classList.contains('status-ready');
            if (aReady === bReady) return 0;
            return aReady ? 1 : -1; // Ready items go to bottom
        });
        items.forEach(item => container.appendChild(item));
    }

    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.item-ticket:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // 5. Print Ticket Logic
    window.printTicket = function(name, qty, table, notes) {
        const content = `
            <div style="font-family: 'Courier New', monospace; width: 300px; padding: 10px; color: black;">
                <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 2px dashed black; padding-bottom: 10px; margin-bottom: 10px;">
                    <h2 style="margin: 0; font-size: 1.5rem;">Table ${table}</h2>
                    <span style="font-size: 0.8rem;">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                </div>
                <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 5px;">
                    ${qty} x ${name}
                </div>
                ${notes ? `<div style="margin-top: 5px; font-style: italic;">Note: ${notes}</div>` : ''}
                <div style="margin-top: 20px; border-top: 1px solid black; padding-top: 5px; text-align: center; font-size: 0.8rem;">
                    KITCHEN TICKET
                </div>
            </div>
        `;
        
        const printWindow = window.open('', '', 'height=500,width=400');
        printWindow.document.write('<html><head><title>Print Ticket</title></head><body style="margin:0">');
        printWindow.document.write(content);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        
        setTimeout(() => {
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }, 500);
    };

    // 6. Print All New Tickets in a Station
    window.printStationTickets = function(stationId) {
        const stationCol = document.querySelector(`.station-col[data-station-id="${stationId}"]`);
        if (!stationCol) return;

        const ticketsToPrint = stationCol.querySelectorAll('.item-ticket:not(.was-printed)');

        if (ticketsToPrint.length === 0) {
            // Optionally provide feedback, or just do nothing.
            // A small visual cue on the button could be good.
            return;
        }

        let combinedContent = '';
        const separator = '<div style="border-top: 2px dashed black; margin: 20px 0; page-break-after: always;"></div>';

        ticketsToPrint.forEach((ticket, index) => {
            const name = ticket.dataset.itemName;
            const qty = ticket.dataset.itemQty;
            const table = ticket.dataset.tableNum;
            const notes = ticket.dataset.itemNotes;

            const ticketContent = `
                <div style="font-family: 'Courier New', monospace; width: 300px; padding: 10px; color: black;">
                    <div style="display: flex; justify-content: space-between; align-items-center; border-bottom: 2px dashed black; padding-bottom: 10px; margin-bottom: 10px;">
                        <h2 style="margin: 0; font-size: 1.5rem;">Table ${table}</h2>
                        <span style="font-size: 0.8rem;">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    </div>
                    <div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 5px;">${qty} x ${name}</div>
                    ${notes ? `<div style="margin-top: 5px; font-style: italic;">Note: ${notes}</div>` : ''}
                </div>
            `;
            
            combinedContent += ticketContent;
            if (index < ticketsToPrint.length - 1) {
                combinedContent += separator;
            }
        });

        const printWindow = window.open('', '', 'height=800,width=500');
        printWindow.document.write(`<html><head><title>Print Station Tickets</title></head><body style="margin:0">${combinedContent}</body></html>`);
        printWindow.document.close();
        
        setTimeout(() => {
            printWindow.focus();
            printWindow.print();
            printWindow.close();
            ticketsToPrint.forEach(ticket => ticket.classList.add('was-printed'));
        }, 500);
    };
});
</script>
{% endblock %}