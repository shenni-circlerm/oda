{% extends "base.html" %}

{% block title %}Menu Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row h-100">
        <!-- Left Column: Item List -->
        <div class="col-md-4 col-lg-3 border-end bg-white p-0" style="min-height: calc(100vh - 100px);">
            <div class="p-3 border-bottom bg-light d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0">Menu Items</h5>
                <form action="{{ url_for('admin.add_menu_item') }}" method="POST" class="m-0">
                    <input type="hidden" name="quick_add" value="true">
                    <button type="submit" class="btn btn-sm btn-primary rounded-pill"><i class="bi bi-plus-lg"></i> New</button>
                </form>
            </div>
            <div class="list-group list-group-flush overflow-auto" style="max-height: calc(100vh - 160px);">
                {% for item in items %}
                <a href="{{ url_for('admin.manage_menu', item_id=item.id) }}" 
                   class="list-group-item list-group-item-action py-3 border-0 {% if selected_item and selected_item.id == item.id %}bg-secondary bg-opacity-10{% endif %}">
                    <div class="d-flex justify-content-between align-items-start mb-1">
                        <span class="fw-bold text-truncate">{{ item.name }}</span>
                        <span class="badge rounded-pill {{ 'bg-success' if item.is_available else 'bg-secondary' }}">
                            {{ 'Active' if item.is_available else 'Inactive' }}
                        </span>
                    </div>
                    {% for category in item.categories %}
                    <div class="small text-muted mb-1"><i class="bi bi-tag me-1"></i>{{ category.name }}</div>
                    {% endfor %}
                    <div class="d-flex justify-content-between align-items-end">
                        <small class="text-muted text-truncate" style="max-width: 150px;">{{ item.sku if item.sku else 'No SKU' }}</small>
                        <span class="fw-bold text-primary">${{ "%.2f"|format(item.price) }}</span>
                    </div>
                </a>
                {% else %}
                <div class="text-center py-5 text-muted">
                    <p class="mb-0">No menu items yet.</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Right Column: Edit / Preview -->
        <div class="col-md-8 col-lg-9 p-4 bg-light">
            {% if selected_item %}
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0 py-3 px-4 d-flex justify-content-between align-items-center">
                    <h4 class="fw-bold mb-0">{{ selected_item.name }}</h4>
                    <div class="dropdown">
                        <button class="btn btn-link text-dark p-0" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-three-dots-vertical fs-5"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end border-0 shadow">
                            <li>
                                <button class="dropdown-item" onclick="toggleItemStatus({{ selected_item.id }})">
                                    <i class="bi bi-toggle-{{ 'on text-success' if selected_item.is_available else 'off text-muted' }} me-2"></i>
                                    {{ 'Mark Unavailable' if selected_item.is_available else 'Mark Available' }}
                                </button>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li><button class="dropdown-item text-danger" data-bs-toggle="modal" data-bs-target="#deleteItemModal"><i class="bi bi-trash me-2"></i>Delete</button></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body p-4 overflow-auto">
                    <form action="{{ url_for('admin.edit_menu_item', item_id=selected_item.id) }}" method="POST" enctype="multipart/form-data">
                        <div class="row">
                            <div class="col-md-4 mb-4">
                                <div class="text-center">
                                    <div id="drop-zone" class="position-relative mb-3" style="cursor: pointer;">
                                        <img id="item-image-preview" src="{{ url_for('admin.serve_menu_image', item_id=selected_item.id) if selected_item.image_data else '' }}" class="rounded-3 shadow-sm bg-light {{ 'd-none' if not selected_item.image_data else '' }}" style="width: 100%; height: 200px; object-fit: cover;">
                                        <div id="image-placeholder-text" class="rounded-3 border border-2 d-flex align-items-center justify-content-center bg-light text-muted {{ 'd-none' if selected_item.image_data else '' }}" style="width: 100%; height: 200px; border-style: dashed !important;">
                                            <div class="text-center">
                                                <i class="bi bi-cloud-upload fs-1"></i>
                                                <div class="mt-2 small fw-bold">Upload or Drag Image</div>
                                            </div>
                                        </div>
                                        <div id="drop-overlay" class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-primary bg-opacity-75 text-white rounded-3" style="opacity: 0; pointer-events: none; transition: opacity 0.2s;">
                                            <div class="text-center">
                                                <i class="bi bi-cloud-arrow-up-fill fs-1"></i>
                                                <div class="fw-bold">Drop Image Here</div>
                                            </div>
                                        </div>
                                    </div>
                                    <input type="file" name="image" id="image-input" class="d-none" accept="image/*" onchange="previewImage(this)">
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="row g-3">
                                    <div class="col-md-8">
                                        <label class="form-label">Name</label>
                                        <input type="text" name="name" value="{{ selected_item.name }}" class="form-control" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label">SKU</label>
                                        <input type="text" name="sku" value="{{ selected_item.sku or '' }}" class="form-control">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Price</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" step="0.01" name="price" value="{{ selected_item.price }}" class="form-control" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Original Price (Slashed)</label>
                                        <div class="input-group">
                                            <span class="input-group-text text-decoration-line-through">$</span>
                                            <input type="number" step="0.01" name="compare_at_price" value="{{ selected_item.compare_at_price or '' }}" class="form-control" placeholder="Optional">
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label mb-2">Category</label>
                                        <div class="d-flex flex-wrap gap-2 align-items-center">
                                            {% for category in categories %}
                                            <input type="checkbox" class="btn-check" name="categories" id="cat{{ category.id }}" value="{{ category.id }}" autocomplete="off" 
                                                {% if category in selected_item.categories %}checked{% endif %}>
                                            <label class="btn btn-outline-secondary btn-sm rounded-pill" for="cat{{ category.id }}">
                                                {{ category.name }}
                                            </label>
                                            {% endfor %}
                                            <button type="button" class="btn btn-sm btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center" data-bs-toggle="modal" data-bs-target="#addCategoryModal" style="width: 32px; height: 32px;" title="Add new category">
                                                <i class="bi bi-plus-lg"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label">Description</label>
                                        <textarea name="description" class="form-control" rows="3">{{ selected_item.description }}</textarea>
                                    </div>
                                    <input type="checkbox" name="is_available" {% if selected_item.is_available %}checked{% endif %} hidden>
                                    <div class="col-12 mt-3">
                                        <button type="submit" class="btn btn-primary rounded-pill px-4">Save Changes</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>

                    <hr class="text-muted opacity-25 my-4">

                    <!-- Modifiers Section -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="fw-bold mb-0">Options & Modifiers</h5>
                        <button class="btn btn-sm btn-outline-primary rounded-pill" data-bs-toggle="modal" data-bs-target="#addModifierGroupModal">
                            <i class="bi bi-plus-lg me-1"></i> Add Group
                        </button>
                    </div>

                    {% if selected_item.modifiers %}
                        {% for group in selected_item.modifiers %}
                        <div class="card border-0 shadow-sm mb-3 bg-white">
                            <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center py-3">
                                <div>
                                    <span class="fw-bold">{{ group.name }}</span>
                                    <span class="badge bg-light text-dark border ms-2">
                                        {% if group.selection_type == 'single' %}
                                            Single Select {{ '(Required)' if group.is_required else '(Optional)' }}
                                        {% else %}
                                            Multi Select 
                                            {% if group.min_selection > 0 or group.max_selection %}
                                                (
                                                {%- if group.min_selection == group.max_selection -%}
                                                    Select {{ group.min_selection }}
                                                {%- else -%}
                                                    {{ group.min_selection if group.min_selection else '0' }} - {{ group.max_selection if group.max_selection else 'Any' }}
                                                {%- endif -%}
                                                )
                                            {% endif %}
                                        {% endif %}
                                    </span>
                                </div>
                                <form action="{{ url_for('admin.delete_modifier_group', group_id=group.id) }}" method="POST" onsubmit="return confirm('Delete this group and all its options?');">
                                    <button type="submit" class="btn btn-sm btn-link text-danger p-0"><i class="bi bi-trash"></i></button>
                                </form>
                            </div>
                            <div class="card-body pt-0">
                                <ul class="list-group list-group-flush mb-3">
                                    {% for option in group.options %}
                                    <li class="list-group-item px-0 d-flex justify-content-between align-items-center border-bottom-0 py-1">
                                        <span>{{ option.name }} <span class="text-muted small">({{ "+$%.2f"|format(option.price_override) if option.price_override > 0 else "Free" }})</span></span>
                                        <form action="{{ url_for('admin.delete_modifier_option', option_id=option.id) }}" method="POST">
                                            <button type="submit" class="btn btn-sm btn-link text-muted p-0"><i class="bi bi-x-lg"></i></button>
                                        </form>
                                    </li>
                                    {% endfor %}
                                </ul>
                                <form action="{{ url_for('admin.add_modifier_option') }}" method="POST" class="d-flex gap-2">
                                    <input type="hidden" name="group_id" value="{{ group.id }}">
                                    <input type="text" name="name" class="form-control form-control-sm" placeholder="Option Name (e.g. 50% Sugar)" required>
                                    <input type="number" step="0.01" name="price" class="form-control form-control-sm" placeholder="Price (+)" style="max-width: 100px;">
                                    <button type="submit" class="btn btn-sm btn-light border"><i class="bi bi-plus-lg"></i></button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4 border rounded-3 bg-white text-muted">
                            <p class="mb-0">No options configured (e.g. Sugar Level, Toppings).</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Delete Confirmation Modal -->
            <div class="modal fade" id="deleteItemModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header border-0">
                            <h5 class="modal-title fw-bold">Delete Item</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <p class="text-muted">Are you sure you want to delete <strong>{{ selected_item.name }}</strong>? This action cannot be undone.</p>
                            <div class="d-flex justify-content-end gap-2 mt-4">
                                <button type="button" class="btn btn-light rounded-pill" data-bs-dismiss="modal">Cancel</button>
                                <form action="{{ url_for('admin.delete_menu_item', item_id=selected_item.id) }}" method="POST">
                                    <button type="submit" class="btn btn-danger rounded-pill px-4">Delete</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="d-flex flex-column justify-content-center align-items-center h-100 text-muted">
                <i class="bi bi-egg-fried fs-1 mb-3 opacity-25"></i>
                <p>Select an item to preview or edit.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Category Modal -->
<div class="modal fade" id="addCategoryModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Add Category</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('admin.categories') }}" method="POST">
                <input type="hidden" name="return_to" value="{{ request.url }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input type="text" name="name" class="form-control" placeholder="e.g. Desserts" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Menus</label>
                        <div class="border rounded p-2" style="max-height: 150px; overflow-y: auto;">
                            {% for menu in menus %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="menu_ids" value="{{ menu.id }}" id="quick_menu_{{ menu.id }}">
                                <label class="form-check-label" for="quick_menu_{{ menu.id }}">{{ menu.name }}</label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="submit" class="btn btn-primary w-100 rounded-pill">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Modifier Group Modal -->
<div class="modal fade" id="addModifierGroupModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold">Add Option Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('admin.add_modifier_group') }}" method="POST">
                <input type="hidden" name="item_id" value="{{ selected_item.id }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Group Name</label>
                        <input type="text" name="name" class="form-control" placeholder="e.g. Sugar Level" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Type</label>
                        <select name="selection_type" class="form-select" id="mod-type-select">
                            <option value="single">Single Selection (Radio)</option>
                            <option value="multiple">Multiple Selection (Checkbox)</option>
                        </select>
                    </div>
                    <div class="form-check form-switch" id="mod-req-div">
                        <input class="form-check-input" type="checkbox" name="is_required" id="reqCheck">
                        <label class="form-check-label" for="reqCheck">Required Selection</label>
                    </div>
                    <div class="row g-2 d-none" id="mod-limits-div">
                        <div class="col-6">
                            <label class="form-label small">Min Select</label>
                            <input type="number" name="min_selection" class="form-control" min="0" placeholder="0">
                        </div>
                        <div class="col-6">
                            <label class="form-label small">Max Select</label>
                            <input type="number" name="max_selection" class="form-control" min="1" placeholder="Any">
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="submit" class="btn btn-primary w-100 rounded-pill">Create Group</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function previewImage(input) {
    if (input.files && input.files[0]) {
        var reader = new FileReader();
        reader.onload = function(e) {
            var img = document.getElementById('item-image-preview');
            var placeholder = document.getElementById('image-placeholder-text');
            img.src = e.target.result;
            img.classList.remove('d-none');
            if (placeholder) placeholder.classList.add('d-none');
        }
        reader.readAsDataURL(input.files[0]);
    }
}

function toggleItemStatus(itemId) {
    fetch(`/admin/availability/toggle/${itemId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => {
        if (response.ok) window.location.reload();
        else alert('Failed to update status.');
    })
    .catch(err => {
        console.error(err);
        alert('Network error.');
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('drop-zone');
    const dropOverlay = document.getElementById('drop-overlay');
    const fileInput = document.getElementById('image-input');

    if (dropZone && fileInput) {
        // Click to upload
        dropZone.addEventListener('click', () => fileInput.click());

        // Drag and Drop events
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropOverlay.style.opacity = '1', false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropOverlay.style.opacity = '0', false);
        });

        dropZone.addEventListener('drop', (e) => {
            const dt = e.dataTransfer;
            if (dt.files && dt.files.length > 0) {
                fileInput.files = dt.files;
                previewImage(fileInput);
            }
        }, false);
    }

    // Modifier Modal Logic
    const modTypeSelect = document.getElementById('mod-type-select');
    const modReqDiv = document.getElementById('mod-req-div');
    const modLimitsDiv = document.getElementById('mod-limits-div');
    if(modTypeSelect) {
        modTypeSelect.addEventListener('change', function() {
            const isMulti = this.value === 'multiple';
            modReqDiv.classList.toggle('d-none', isMulti);
            modLimitsDiv.classList.toggle('d-none', !isMulti);
        });
    }
});
</script>
{% endblock %}