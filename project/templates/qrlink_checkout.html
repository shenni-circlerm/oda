{% extends "customer_base.html" %}

{% block title %}{{ restaurant.name }} - Checkout{% endblock %}

{% block styles %}
<style>
    :root {
        --brand-color: #2d3436;
        --accent-color: #e67e22;
        --bg-light: #fcfcfc;
    }

    body { 
        background-color: var(--bg-light); 
        font-family: 'Inter', -apple-system, sans-serif;
    }

    .checkout-card {
        border-radius: 20px;
        border: none;
        background: white;
    }

    .order-item {
        border-bottom: 1px solid rgba(0,0,0,0.05);
        padding-bottom: 1rem;
        margin-bottom: 1rem;
    }

    /* Modern Quantity Toggle */
    .qty-control {
        background: #f8f9fa;
        border-radius: 50px;
        padding: 4px 8px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .qty-btn {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: none;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
    }

    .qty-btn:active {
        transform: scale(0.9);
        background: var(--brand-color);
        color: white;
    }

    /* Fixed Footer Button Container */
    .sticky-checkout-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 20px;
        border-top: 1px solid #eee;
        z-index: 1000;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
    }

    .btn-place-order {
        background-color: var(--brand-color) !important;
        border: none;
        border-radius: 50px;
        padding: 14px;
        font-weight: 600;
        transition: opacity 0.2s;
    }

    .btn-place-order:disabled {
        opacity: 0.5;
    }

    .price-subtotal {
        color: var(--accent-color);
        font-weight: 700;
    }
</style>
{% endblock %}

{% block content %}
<div class="container pb-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="d-flex align-items-center mb-4 mt-3">
                <a href="{{ url_for('qrlink.customer_menu', slug=restaurant.slug, table=table.number if table else None, type=request.args.get('type')) }}" class="btn btn-light rounded-circle me-3">
                    <i class="bi bi-chevron-left"></i>
                </a>
                <h4 class="fw-bold mb-0">Review Order</h4>
            </div>

            <div class="card checkout-card shadow-sm mb-4">
                <div class="card-body p-4">
                    <div id="cart-items-container">
                        </div>
                </div>
            </div>

            <div class="px-2 mb-4">
                <div class="d-flex justify-content-between text-muted mb-2">
                    <span>Subtotal</span>
                    <span id="subtotal-amount">$0.00</span>
                </div>
                <div class="d-flex justify-content-between text-muted mb-2 d-none" id="tax-row">
                    <span>Tax <span id="tax-rate"></span></span>
                    <span id="tax-amount">$0.00</span>
                </div>
                <div class="d-flex justify-content-between fw-bold fs-5">
                    <span>Total</span>
                    <span class="price-subtotal" id="cart-total">$0.00</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="sticky-checkout-footer">
    <div class="container col-md-8 col-lg-6">
        <button id="checkout-button" class="btn btn-primary w-100 btn-place-order" onclick="submitOrder()">
            Place Order • <span id="footer-total">$0.00</span>
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const tableId = "{{ table.id if table else '' }}";
    const restaurantId = "{{ restaurant.id }}";
    const orderType = new URLSearchParams(window.location.search).get('type');
    const taxRate = {{ restaurant.tax_rate or 0.0 }};
    function getCart() {
        const cartData = localStorage.getItem('cart');
        try {
            const cart = JSON.parse(cartData || '[]');
            // Ensure the cart is always an array to prevent errors from old data formats.
            if (Array.isArray(cart)) {
                return cart;
            }
            return []; // Return empty array if cart is not an array (e.g., old object format)
        } catch (e) {
            return []; // Return empty array if JSON is invalid
        }
    }

    function saveCart(cart) {
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCart();
    }

    function updateQuantity(id, change) {
        let cart = getCart();
        const itemIndex = cart.findIndex(item => item.cartId === id);
        if (itemIndex > -1) {
            cart[itemIndex].quantity += change;
            if (cart[itemIndex].quantity <= 0) {
                cart.splice(itemIndex, 1);
            }
            saveCart(cart);
        }
    }

    function renderCart() {
        const cart = getCart();
        const container = document.getElementById('cart-items-container');
        const grandTotalEl = document.getElementById('cart-total');
        const footerTotal = document.getElementById('footer-total');
        const subtotalEl = document.getElementById('subtotal-amount');
        const checkoutButton = document.getElementById('checkout-button');
        
        container.innerHTML = '';
        let subtotal = 0;

        if (cart.length === 0) {
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-basket2 text-muted" style="font-size: 3rem;"></i>
                    <h5 class="mt-3 fw-bold">Empty Cart</h5>
                    <p class="text-muted small">You haven't added any items yet.</p>
                </div>`;
            checkoutButton.disabled = true;
        } else {
            checkoutButton.disabled = false;
            cart.forEach(item => {
                let itemTotal = item.price; // Price already includes modifiers
                subtotal += itemTotal * item.quantity;

                let modifiersHtml = '';
                if (item.modifiers && item.modifiers.length > 0) {
                    modifiersHtml = '<ul class="list-unstyled small text-muted ps-3 mb-0">';
                    item.modifiers.forEach(mod => {
                        modifiersHtml += `<li>+ ${mod.name}</li>`;
                    });
                    modifiersHtml += '</ul>';
                }

                container.innerHTML += `
                    <div class="d-flex justify-content-between align-items-center order-item">
                        <div>
                            <h6 class="fw-bold mb-1">${item.name}</h6>
                            ${item.notes ? `<p class="small text-danger mb-1 fst-italic">Note: ${item.notes}</p>` : ''}
                            ${modifiersHtml}
                            <span class="text-muted small">$${item.price.toFixed(2)}</span>
                        </div>
                        <div class="qty-control shadow-sm">
                            <button class="qty-btn" onclick="updateQuantity('${item.cartId}', -1)"><i class="bi bi-dash"></i></button>
                            <span class="fw-bold small">${item.quantity}</span>
                            <button class="qty-btn" onclick="updateQuantity('${item.cartId}', 1)"><i class="bi bi-plus"></i></button>
                        </div>
                    </div>
                `;
            });
        }

        const taxAmount = subtotal * taxRate;
        const grandTotal = subtotal + taxAmount;

        subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
        
        // Add tax row if applicable
        if (taxRate > 0) {
            document.getElementById('tax-row').classList.remove('d-none');
            document.getElementById('tax-rate').textContent = `(${(taxRate * 100).toFixed(2)}%)`;
            document.getElementById('tax-amount').textContent = `$${taxAmount.toFixed(2)}`;
        } else {
            document.getElementById('tax-row').classList.add('d-none');
        }

        const formattedTotal = `$${grandTotal.toFixed(2)}`;
        grandTotalEl.textContent = formattedTotal;
        footerTotal.textContent = formattedTotal;
    }

    function submitOrder() {
        let cart = getCart();
        if (cart.length === 0) return;

        // Visual feedback on click
        const btn = document.getElementById('checkout-button');
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
        btn.disabled = true;

        const itemsForServer = cart.map(item => ({ 
            menu_item_id: item.id, 
            quantity: item.quantity, 
            notes: item.notes,
            modifiers: item.modifiers ? item.modifiers.map(m => m.id) : []
        }));

        fetch("{{ url_for('qrlink.place_order') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ table_id: tableId, restaurant_id: restaurantId, order_type: orderType, items: itemsForServer })
        })
        .then(res => {
            if (!res.ok) {
                return res.text().then(text => { throw new Error(text || `Server error: ${res.status}`) });
            }
            return res.json();
        })
        .then(data => {
            if (data.success) {
                localStorage.removeItem('cart');
                window.location.href = `/qrlink/{{ restaurant.slug }}/thanks/${data.order_id}`;
            } else {
                alert("Issue: " + data.message);
                btn.innerHTML = 'Place Order • ' + document.getElementById('cart-total').textContent;
                btn.disabled = false;
            }
        }).catch(error => {
            console.error('Order submission failed:', error);
            alert('An error occurred while placing your order. Please check the console for details.');
            btn.innerHTML = 'Place Order • ' + document.getElementById('cart-total').textContent;
            btn.disabled = false;
        });
    }

    document.addEventListener('DOMContentLoaded', renderCart);
</script>
{% endblock %}