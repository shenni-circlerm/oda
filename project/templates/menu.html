{% extends "base.html" %}

{% block title %}{{ restaurant.name }}{% endblock %}

{% block content %}
<div class="menu-wrapper container-fluid px-0">
    <div class="restaurant-header text-center">
        <h1 class="fw-bold mb-2">{{ restaurant.name }}</h1>
        <div class="d-flex justify-content-center align-items-center gap-3">
            <span class="badge bg-light text-dark border px-3 py-2 rounded-pill">Table {{ table.number }}</span>
            <button class="btn btn-outline-dark btn-sm rounded-pill px-3" onclick="callStaff()">
                <i class="bi bi-bell"></i> Call Staff
            </button>
        </div>
    </div>

    <div class="container">
        <div class="row g-4">
            {% for item in menu %}
            <div class="col-md-6 col-lg-4 col-xl-3">
                <div class="card h-100">
                    {% if item.image_filename %}
                    <img src="{{ url_for('static', filename='uploads/menu_items/' + item.image_filename) }}" class="card-img-top" alt="{{ item.name }}" style="height: 220px; object-fit: cover;">
                    {% endif %}
                    <div class="card-body d-flex flex-column">
                        <div class="mb-3">
                            <h5 class="card-title fw-bold">{{ item.name }}</h5>
                            <p class="card-text text-muted small">{{ item.description }}</p>
                        </div>
                        <div class="mt-auto d-flex justify-content-between align-items-center">
                            <span class="h5 mb-0 fw-bold">${{ "%.2f"|format(item.price) }}</span>
                            {% if item.is_available %}
                            <button class="btn btn-primary btn-sm" onclick="addToCart({{ item.id }}, '{{ item.name }}', {{ item.price }})">
                                Add
                            </button>
                            {% else %}
                            <button class="btn btn-secondary btn-sm rounded-pill" disabled>Sold Out</button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Floating Cart Button -->
<div class="fixed-bottom p-3" id="cart-bar">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <strong class="h5">Total: $<span id="cart-total">0.00</span></strong>
            <small class="text-muted">(<span id="cart-count">0</span> items)</small>
        </div>
        <button class="btn btn-success rounded-pill px-4 fw-bold" onclick="placeOrder()">Place Order</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let cart = [];
const tableId = {{ table.id }};

function addToCart(id, name, price) {
    if (navigator.vibrate) {
        navigator.vibrate(50); // Haptic feedback
    }
    cart.push({id, name, price});
    updateCartUI();
}

function updateCartUI() {
    const total = cart.reduce((sum, item) => sum + item.price, 0);
    document.getElementById('cart-total').innerText = total.toFixed(2);
    document.getElementById('cart-count').innerText = cart.length;
    
    const cartBar = document.getElementById('cart-bar');
    if (cart.length > 0) {
        cartBar.classList.add('show');
    } else {
        cartBar.classList.remove('show');
    }
}

function placeOrder() {
    if (cart.length === 0) return;
    
    fetch('/place-order', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            table_id: tableId,
            items: cart
        })
    })
    .then(response => response.json())
    .then(data => {
        alert('Order Placed Successfully!');
        cart = [];
        updateCartUI();
    });
}

function callStaff() {
    fetch('/request-service', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({table_id: tableId})
    }).then(() => alert('Staff has been notified!'));
}
</script>
{% endblock %}